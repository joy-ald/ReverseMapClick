<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US County Choropleth Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 700px;
        }
        .county {
            stroke: #fff;
            stroke-width: 0.5;
        }
        .state-borders {
            fill: none;
            stroke: #000;
            stroke-width: 0.5;
        }
        #tooltip {
            position: absolute;
            background: #f9f9f9;
            padding: 5px;
            border: 1px solid #ccc;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <h1>US County Choropleth Map</h1>
    <div id="map"></div>

    <script>
        // Set up the dimensions and map projection
        var width = 960, height = 600;

        var projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2])
            .scale([1000]);

        var path = d3.geoPath().projection(projection);

        var colorScale = d3.scaleQuantize()
            .range(["#f7f7f7", "#f0f0f0", "#d9d9d9", "#bdbdbd", "#969696", "#636363", "#252525"]);

        // Create an SVG element to hold the map
        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        // Load the GeoJSON file for county boundaries and the CSV data
        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json"),  // GeoJSON file for counties
            d3.csv("population_data.csv")         // CSV file with county data
        ]).then(function([geojson, countyData]) {
            // GeoJSON counties
            var counties = geojson.features;

            // Map CSV data to a more accessible format
            var countyMap = {};
            countyData.forEach(function(d) {
                countyMap[d.state + "_" + d.county] = {
                    JD1: +d.JD1,
                    JD2: +d.JD2,
                    JD3: +d.JD3,
                    JD4: +d.JD4,
                    JD5: +d.JD5,
                    JD6: +d.JD6,
                    JD7: +d.JD7,
                    JD8: +d.JD8
                };
            });

            // Merge the county data with the boundaries
            counties.forEach(function(county) {
                var key = county.properties.STATEFP + "_" + county.properties.NAME;
                var data = countyMap[key];
                if (data) {
                    // Sum up the population of all jurisdictions for coloring the county
                    county.properties.totalPopulation = Object.values(data).reduce((sum, value) => sum + value, 0);
                } else {
                    county.properties.totalPopulation = 0;  // If no data is found for the county, set population to 0
                }
            });

            // Set the domain of the color scale based on population data
            colorScale.domain([d3.min(counties, d => d.properties.totalPopulation),
                               d3.max(counties, d => d.properties.totalPopulation)]);

            // Add the counties to the map and color them based on population
            svg.selectAll(".county")
                .data(counties)
                .enter().append("path")
                .attr("class", "county")
                .attr("d", path)
                .style("fill", function(d) {
                    return colorScale(d.properties.totalPopulation);
                })
                .style("stroke", "#fff")
                .style("stroke-width", 0.5)
                .on("mouseover", function(event, d) {
                    var countyName = d.properties.NAME;
                    var population = d.properties.totalPopulation;
                    d3.select(this).style("stroke", "black").style("stroke-width", 2);
                    // Show the tooltip with county data
                    d3.select("#tooltip")
                        .html(countyName + "<br>Population: " + population)
                        .style("visibility", "visible");
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).style("stroke", "#fff").style("stroke-width", 0.5);
                    d3.select("#tooltip").style("visibility", "hidden");
                });

            // Tooltip for mouseover
            svg.append("text")
                .attr("id", "tooltip")
                .style("visibility", "hidden")
                .style("position", "absolute")
                .style("background", "#f9f9f9")
                .style("padding", "5px")
                .style("border", "1px solid #ccc");

            // Add state borders
            svg.append("path")
                .datum(topojson.mesh(geojson, geojson.objects.states, function(a, b) { return a !== b; }))
                .attr("class", "state-borders")
                .attr("d", path)
                .style("fill", "none")
                .style("stroke", "#000")
                .style("stroke-width", 0.5);
        });

    </script>
</body>
</html>
