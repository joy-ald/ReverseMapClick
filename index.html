<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US County Population Choropleth Map</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // Function to fetch the population data from CSV
        async function fetchPopulationData() {
            const response = await fetch('population_data.csv');
            const text = await response.text();
            const rows = text.split('\n').map(row => row.split(','));
            const headers = rows[0];
            const data = rows.slice(1).map(row => {
                let rowData = {};
                row.forEach((value, index) => {
                    rowData[headers[index]] = value;
                });
                return rowData;
            });
            return data;
        }

        // Function to fetch the GeoJSON from the URL
        async function fetchGeoJSON() {
            const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
            const geojson = await response.json();
            return geojson;
        }

        // Function to calculate total population by summing up all JDs
        function calculateTotalPopulation(rowData) {
            let totalPopulation = 0;
            // Assuming JD1, JD2, ..., JD8 are the columns we need to sum
            for (let i = 2; i <= 9; i++) {
                totalPopulation += parseInt(rowData[`JD${i}`], 10) || 0;  // Summing JD1 to JD8, using 0 if NaN
            }
            return totalPopulation;
        }

        // Main function to plot the choropleth map
        async function plotMap() {
            // Fetch population data and GeoJSON
            const populationData = await fetchPopulationData();
            const geoJSON = await fetchGeoJSON();

            // Map the population data to GeoJSON
            geoJSON.features.forEach((feature) => {
                const countyFIPS = feature.properties.GEOID;  // Using FIPS code as the unique identifier
                const stateAbbr = feature.properties.STATE;
                
                // Find corresponding population data by FIPS code
                const populationEntry = populationData.find((entry) => 
                    entry.state === stateAbbr && entry.county === feature.properties.NAME
                );

                // Set the population for the feature if data exists
                if (populationEntry) {
                    const totalPopulation = calculateTotalPopulation(populationEntry);
                    feature.properties.population = totalPopulation;
                }
            });

            // Plot the choropleth map using Plotly
            const data = [{
                type: 'choropleth',
                geojson: geoJSON,
                locations: geoJSON.features.map((feature) => feature.properties.GEOID),
                z: geoJSON.features.map((feature) => feature.properties.population),
                colorscale: 'Viridis',
                colorbar: {
                    title: 'Population'
                },
                hovertemplate: '%{location}: %{z}<extra></extra>'
            }];

            const layout = {
                geo: {
                    showlakes: true,
                    lakecolor: 'white',
                    showcoastlines: true,
                    coastlinecolor: 'black',
                    showstates: true,
                    showsubunits: true,
                    subunitcolor: 'black',
                    projection: {
                        type: 'albers usa'
                    },
                    scope: 'usa'
                },
                title: 'US County Population Choropleth Map'
            };

            Plotly.newPlot('map', data, layout);
        }

        // Run the function to plot the map
        plotMap();
    </script>

</body>
</html>
